#!/bin/sh -e
SOURCE=${1?Missing source}
exec <"${2?Missing input}"
exec >"${3?Missing output}"

IFS=

while read -r line
do
	case "$line" in
	(INCLUDE\(*\))
		name=${line#INCLUDE(}
		name=${name%)}
		sed -n '/\/\*MAN('"$name"')/{n;:o;N;s/\*\/$//;To;s/[\t]* \*  *//g;p}' "$SOURCE"
		;;
	(*)
		printf '%s\n' "$line"
		;;
	esac
done
